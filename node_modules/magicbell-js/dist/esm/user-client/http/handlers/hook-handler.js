import { HttpError } from '../error.js';
import { TransportHookAdapter } from '../transport/transport-hook-adapter.js';
import { getContentTypeDefinition } from '../utils/content-type.js';
export class HookHandler {
    constructor(hook) {
        Object.defineProperty(this, "hook", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: hook
        });
        Object.defineProperty(this, "next", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
    }
    async handle(request) {
        var _a;
        if (!this.next) {
            throw new Error('No next handler set in hook handler.');
        }
        const hook = new TransportHookAdapter();
        const hookParams = this.getHookParams(request);
        const nextRequest = await hook.beforeRequest(request, hookParams);
        const response = await this.next.handle(nextRequest);
        if (response.metadata.status < 400) {
            return await hook.afterResponse(nextRequest, response, hookParams);
        }
        // Handle error responses
        const arrayBuffer = response.raw;
        const rawContentType = ((_a = response.metadata.headers['content-type']) === null || _a === void 0 ? void 0 : _a.toLocaleLowerCase()) || '';
        const contentType = getContentTypeDefinition(rawContentType);
        const statusCode = response.metadata.status;
        const error = request.errors.find((error) => {
            return error.contentType === contentType && error.status === statusCode;
        });
        if (error) {
            const decodedBody = new TextDecoder().decode(arrayBuffer);
            const json = JSON.parse(decodedBody);
            new error.error((json === null || json === void 0 ? void 0 : json.message) || '', json).throw();
        }
        const decodedBody = new TextDecoder().decode(arrayBuffer);
        throw new HttpError(response.metadata, arrayBuffer, `Unexpected response body for error status.\nStatusCode: ${response.metadata.status}\nBody: ${decodedBody}`);
    }
    async *stream(request) {
        if (!this.next) {
            throw new Error('No next handler set in hook handler.');
        }
        const hook = new TransportHookAdapter();
        const hookParams = this.getHookParams(request);
        const nextRequest = await hook.beforeRequest(request, hookParams);
        const stream = this.next.stream(nextRequest);
        for await (const response of stream) {
            if (response.metadata.status < 400) {
                yield await hook.afterResponse(nextRequest, response, hookParams);
            }
            else {
                throw await hook.onError(nextRequest, response, hookParams);
            }
        }
    }
    getHookParams(_request) {
        const hookParams = new Map();
        return hookParams;
    }
}
//# sourceMappingURL=hook-handler.js.map