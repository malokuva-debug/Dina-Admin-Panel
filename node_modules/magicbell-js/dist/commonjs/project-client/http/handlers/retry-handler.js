"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RetryHandler = void 0;
const error_js_1 = require("../error.js");
class RetryHandler {
    constructor() {
        Object.defineProperty(this, "next", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: void 0
        });
    }
    async handle(request) {
        if (!this.next) {
            throw new Error('No next handler set in retry handler.');
        }
        for (let attempt = 1; attempt <= request.retry.attempts; attempt++) {
            try {
                return await this.next.handle(request);
            }
            catch (error) {
                if (!this.shouldRetry(error) || attempt === request.retry.attempts) {
                    throw error;
                }
                await this.delay(request.retry.delayMs);
            }
        }
        throw new Error('Error retrying request.');
    }
    async *stream(request) {
        if (!this.next) {
            throw new Error('No next handler set in retry handler.');
        }
        for (let attempt = 1; attempt <= request.retry.attempts; attempt++) {
            try {
                yield* this.next.stream(request);
                return;
            }
            catch (error) {
                if (!this.shouldRetry(error) || attempt === request.retry.attempts) {
                    throw error;
                }
                await this.delay(request.retry.delayMs);
            }
        }
        throw new Error('Error retrying request.');
    }
    shouldRetry(error) {
        return (error instanceof error_js_1.HttpError &&
            (error.metadata.status >= 500 || error.metadata.status === 408 || error.metadata.status === 429));
    }
    delay(delayMs) {
        if (!delayMs) {
            return Promise.resolve();
        }
        return new Promise((resolve, reject) => {
            setTimeout(() => resolve(), delayMs);
        });
    }
}
exports.RetryHandler = RetryHandler;
//# sourceMappingURL=retry-handler.js.map